{% extends "base.html" %}

{% block content %}

<!-- The bars at the top -->
<div class="columns">
    {% if mode == PuzzleMode::Random %}
        <div class="column bt-panel">
            Reviewing random puzzle in rating range {{ min_rating }}-{{ max_rating }}
        </div>
    {% endif %}

    {% if mode == PuzzleMode::Specific %}
        <div class="column bt-panel">
            Reviewing specific puzzle {{ puzzle.puzzle_id }}

            {% if card.review_count == 0 %}
                (unseen)
            {% endif %}
        </div>
    {% endif %}

    {% if mode == PuzzleMode::Review %}
        <div class="column bt-panel">
            Reviewing next puzzle

            {% if stats.reviews_due > 0 %}
                ({{ stats.reviews_due }} reviews left today)
            {% else %}
                (reviewing ahead)
            {% endif %}
        </div>
    {% endif %}
</div>

<!-- The main container, with the puzzle and other panels in it -->
<div class="columns">
    <!-- The board column on the left -->
    <div class="column is-two-thirds bt-panel" id="board-container">
        <div class="chessground" id="board"></div>
    </div>

    <!-- The sidebar -->
    <div class="column sidebar">
        <!-- The puzzle info - always visible -->
        <div id="puzzle-info" class="bt-panel">
            <p>
                Lichess puzzle
                <a href="/tactics/single/{{ puzzle.puzzle_id }}">{{ puzzle.puzzle_id }}</a>
            </p>
            <p>Puzzle rating: {{ puzzle.rating }}</p>
            <p>User rating: {{ user.rating.rating }}</p>
            <a id="analysis-link" target="_blank">Analyse</a>
        </div>

        <!-- The card details (e.g. when it's due, how many times it's been reviewed, etc) -->
        {% if card.review_count != 0 %}
            <div id="card-details" class="bt-panel">
                <table class="stats">
                    <caption>Puzzle stats</caption>
                    <tbody>
                        <tr>
                            <th scope="row">Review count</th>
                            <td>{{ card.review_count }}</td>
                        </tr>
                        <tr>
                            <th scope="row">Ease</th>
                            <td>{{ format!("{:.2}", self.card.ease) }}</td>
                        </tr>
                        <tr>
                            <th scope="row">Due</th>
                            <td>{{ card.human_readable_due() }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        {% endif %}

        <!-- The move indicators, visible when waiting for a move to be played -->
        <div id="white-to-move" class="bt-panel move-indicator">
            <img class="to-move-piece" src="/assets/images/white-queen.svg"><br>
            White to move
        </div>
        <div id="black-to-move" class="bt-panel move-indicator">
            <img class="to-move-piece" src="/assets/images/black-queen.svg"><br>
            Black to move
        </div>
        <div id="white-to-move-computer" class="bt-panel move-indicator">
            <img class="to-move-piece" src="/assets/images/white-queen.svg"><br>
            Computer to move
        </div>
        <div id="black-to-move-computer" class="bt-panel move-indicator">
            <img class="to-move-piece" src="/assets/images/black-queen.svg"><br>
            Computer to move
        </div>

        <!-- The puzzle controls panel, always visible but with various switchable sub-panels -->
        <div id="puzzle-controls" class="bt-panel sidebar-fill">
            <!-- The initial panel shown -->
            <div class="bt-subpanel" id="find-the-line">
                <p>Find the line!</p>
            </div>

            <!-- Shown when the user makes the right move -->
            <div class="bt-subpanel" id="right-move">
                <p>Right move!</p>
            </div>

            <!-- Shown when the user makes the wrong move -->
            <div class="bt-subpanel" id="wrong-move">
                <p>Wrong move :(</p>
                <!-- A button that lets them retry the puzzle -->
                <div class="columns button-container">
                    <div class="column">
                        <button class="button" id="try-again">Reset puzzle</button>
                    </div>
                </div>
            </div>

            <!-- Shown when the user completes the puzzle after making a mistake -->
            <div class="bt-subpanel" id="puzzle-failure">
                <p>Puzzle complete</p>

                <div class="columns button-container">
                    <div class="column">
                        <button class="button review-button" id="again" data-difficulty="0">
                            <p class="main-text">Again</p>
                            <p class="sub-text"></p>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Shown when the user completes the puzzle first try -->
            <div class="bt-subpanel" id="puzzle-success">
                <p>Puzzle complete</p>

                <div class="columns button-container">
                    <div class="column">
                        <button class="button review-button" id="hard" data-difficulty="1">
                            <p class="main-text">Hard</p>
                            <p class="sub-text"></p>
                        </button>
                    </div>
                    <div class="column">
                        <button class="button review-button" id="good" data-difficulty="2">
                            <p class="main-text">Good</p>
                            <p class="sub-text"></p>
                        </button>
                    </div>
                    <div class="column">
                        <button class="button review-button" id="easy" data-difficulty="3">
                            <p class="main-text">Easy</p>
                            <p class="sub-text"></p>
                        </button>
                    </div>
                </div>
            </div>

            {% if !card.is_due() %}
                <br>
                <div>
                    Warning: you are reviewing ahead, which is fine, but it will push this card further
                    into the future each time you complete it.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script type="module">
    import { Puzzle } from '/assets/better-tactics.js';

    const container = document.getElementById("board");

    const puzzle_id = "{{ puzzle.puzzle_id }}";
    const fen = "{{ puzzle.fen }}";
    const moves = "{{ puzzle.moves }}";
    const rating = {{ puzzle.rating }};

    const again_time = "{{ util::review_duration_to_human_owned(card.next_interval(Difficulty::Again)) }}";
    const hard_time = "{{ util::review_duration_to_human_owned(card.next_interval(Difficulty::Hard)) }}";
    const good_time = "{{ util::review_duration_to_human_owned(card.next_interval(Difficulty::Good)) }}";
    const easy_time = "{{ util::review_duration_to_human_owned(card.next_interval(Difficulty::Easy)) }}";

    // Add review time to buttons.
    $('button#again > .sub-text').text(again_time);
    $('button#hard > .sub-text').text(hard_time);
    $('button#good > .sub-text').text(good_time);
    $('button#easy > .sub-text').text(easy_time);

    // Hide move indicators.
    function hide_move_indicators() {
        $('.move-indicator').css('display', 'none');
    }

    // Hide all puzzle control subpanels.
    function hide_puzzle_control_subpanels() {
        $('#puzzle-controls .bt-subpanel').css('display', 'none');
    }

    // Update the side to move interface.
    function update_side_to_move() {
        let color_to_move = document.puzzle.color_to_move();
        let computer_to_move = document.puzzle.computer_to_move();

        hide_move_indicators();

        if (!computer_to_move) {
            if (color_to_move == 'w') {
                $('#white-to-move').css('display', 'initial');
            }
            else {
                $('#black-to-move').css('display', 'initial');
            }
        }
        else {
            if (color_to_move == 'w') {
                $('#white-to-move-computer').css('display', 'initial');
            }
            else {
                $('#black-to-move-computer').css('display', 'initial');
            }
        }
    }

    // Callbacks for puzzle module.
    function on_success() {
        hide_puzzle_control_subpanels();
        hide_move_indicators();

        if (document.first_try) {
            $('#puzzle-success').css('display', 'initial');
        }
        else {
            $('#puzzle-failure').css('display', 'initial');
        }
    }

    function on_move(side_moved, move) {
        if (!$('#analysis-link').attr('href')) {
            // Set the analyze link to point to lichess's analysis board. Make sure to use the puzzle's fen
            // after it's applied the computer's move, since right now there's no way to specify a fen +
            // move for the lichess analysis board via a url.
            let fen_url_safe = document.puzzle.fen().replace(' ', '_');
            let analysis_link = `https://lichess.org/analysis/standard/${fen_url_safe}`;
            $('#analysis-link').attr('href', analysis_link);
        }

        update_side_to_move();
    }

    function right_move() {
        hide_puzzle_control_subpanels();
        $('#right-move').css('display', 'initial');
    }

    function wrong_move() {
        document.first_try = false;

        hide_puzzle_control_subpanels();
        hide_move_indicators();

        $('#wrong-move').css('display', 'initial');
    }

    // Bind buttons.
    $('button#try-again').click(function() {
        hide_puzzle_control_subpanels();
        hide_move_indicators();
        $('#find-the-line').css('display', 'initial');
        document.puzzle.reset();
    });

    $('button.review-button').click(function() {
        let puzzle_id = "{{ puzzle.puzzle_id }}";
        let difficulty = $(this).data('difficulty');
        console.log(`Reviewing ${puzzle_id} with difficulty ${difficulty}`);

        $('button.review-button').prop('disabled', true);

        $.ajax({
            type: "POST",
            url: "/review",
            data: JSON.stringify({
                id: puzzle_id,
                difficulty: difficulty
            }),
            contentType: 'application/json; charset=utf-8',
        })
        .done(function() {
            console.log("Done, reloading");
            window.location.reload();
        })
        .fail(function() {
            console.error("Failed to submit review");
            $('button.review-button').prop('disabled', false);
        });
    });

    // Show the initial subpanel.
    $("#find-the-line").css('display', 'initial');

    // Store whether it's currently the first try or not, so we know if it's a successful solve or not.
    document.first_try = true;

    // Create puzzle.
    document.puzzle = new Puzzle(container, puzzle_id, fen, moves, rating, on_success, on_move,
        right_move, wrong_move);
</script>
{% endblock %}
